# ============================================================
# SonicForge Dockerfile - å¤šé˜¶æ®µæ„å»ºï¼ˆä½¿ç”¨ Debian Bullseyeï¼‰
# ============================================================

# é˜¶æ®µ 1: ä¾èµ–å®‰è£…
FROM node:20-bullseye AS deps

# é…ç½® Debian ä½¿ç”¨å›½å†…é•œåƒæºï¼ˆä¼˜å…ˆä½¿ç”¨é˜¿é‡Œäº‘ï¼Œæ›´ç¨³å®šï¼‰
RUN sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources 2>/dev/null || \
    sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list || \
    echo "deb http://mirrors.aliyun.com/debian bullseye main contrib non-free" > /etc/apt/sources.list && \
    echo "deb http://mirrors.aliyun.com/debian bullseye-updates main contrib non-free" >> /etc/apt/sources.list && \
    echo "deb http://mirrors.aliyun.com/debian-security bullseye-security main contrib non-free" >> /etc/apt/sources.list

# å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆä½¿ç”¨ apt-getï¼Œæ›´ç¨³å®šï¼‰
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      python3 \
      python3-pip \
      build-essential \
      mariadb-client \
      ca-certificates \
      && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# é…ç½® npm ä½¿ç”¨æ·˜å®é•œåƒæºï¼ˆåªè®¾ç½®æœ‰æ•ˆçš„é…ç½®é¡¹ï¼‰
RUN npm config set registry https://registry.npmmirror.com

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY package.json package-lock.json* pnpm-lock.yaml* ./

# å®‰è£…ä¾èµ–ï¼ˆè·³è¿‡ postinstall è„šæœ¬ï¼Œå› ä¸º prisma ç›®å½•è¿˜æ²¡æœ‰å¤åˆ¶ï¼‰
RUN \
  if [ -f package-lock.json ]; then npm ci --ignore-scripts; \
  elif [ -f pnpm-lock.yaml ]; then corepack enable pnpm && pnpm config set registry https://registry.npmmirror.com && pnpm i --frozen-lockfile --ignore-scripts; \
  else echo "Lockfile not found." && exit 1; \
  fi

# é˜¶æ®µ 2: æ„å»ºåº”ç”¨
FROM node:20-bullseye AS builder

# é…ç½® Debian ä½¿ç”¨å›½å†…é•œåƒæºï¼ˆä¼˜å…ˆä½¿ç”¨é˜¿é‡Œäº‘ï¼Œæ›´ç¨³å®šï¼‰
RUN sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources 2>/dev/null || \
    sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list || \
    echo "deb http://mirrors.aliyun.com/debian bullseye main contrib non-free" > /etc/apt/sources.list && \
    echo "deb http://mirrors.aliyun.com/debian bullseye-updates main contrib non-free" >> /etc/apt/sources.list && \
    echo "deb http://mirrors.aliyun.com/debian-security bullseye-security main contrib non-free" >> /etc/apt/sources.list

WORKDIR /app

# é…ç½® npm ä½¿ç”¨æ·˜å®é•œåƒæºï¼ˆåªè®¾ç½®æœ‰æ•ˆçš„é…ç½®é¡¹ï¼‰
RUN npm config set registry https://registry.npmmirror.com

# å¤åˆ¶ä¾èµ–
COPY --from=deps /app/node_modules ./node_modules
COPY . .

# è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆæ„å»ºæ—¶ï¼‰
ENV NEXT_TELEMETRY_DISABLED=1
ENV NODE_ENV=production
# æ„å»ºæ—¶éœ€è¦ä¸€ä¸ªå ä½ç¬¦çš„ DATABASE_URLï¼ˆPrisma åªéœ€è¦éªŒè¯æ ¼å¼ï¼Œä¸ä¼šå®é™…è¿æ¥ï¼‰
ENV DATABASE_URL="mysql://build:build@localhost:3306/build?schema=public"

# NEXT_PUBLIC_* å˜é‡å¿…é¡»åœ¨æ„å»ºæ—¶è®¾ç½®ï¼ˆä¼šè¢«å†…è”åˆ°å®¢æˆ·ç«¯ä»£ç ä¸­ï¼‰
# é€šè¿‡ ARG æ¥æ”¶æ„å»ºå‚æ•°ï¼Œç„¶åè®¾ç½®ä¸º ENV
ARG NEXT_PUBLIC_SITE_URL=https://music.aizeek.com
ENV NEXT_PUBLIC_SITE_URL=${NEXT_PUBLIC_SITE_URL}

# ç”Ÿæˆ Prisma Clientï¼ˆåœ¨æ„å»ºå‰ï¼‰
RUN npx prisma generate

# æ„å»ºåº”ç”¨ï¼ˆä½¿ç”¨ standalone è¾“å‡ºæ¨¡å¼ï¼‰
RUN \
  if [ -f package-lock.json ]; then npm run build; \
  elif [ -f pnpm-lock.yaml ]; then corepack enable pnpm && pnpm run build; \
  else npm run build; \
  fi

# éªŒè¯ standalone è¾“å‡ºæ˜¯å¦å­˜åœ¨
RUN test -d .next/standalone || (echo "é”™è¯¯: standalone è¾“å‡ºä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥ next.config.ts ä¸­çš„ output: 'standalone' é…ç½®" && exit 1)

# é˜¶æ®µ 3: è¿è¡Œæ—¶
FROM node:20-bullseye AS runner

# é…ç½® Debian ä½¿ç”¨å›½å†…é•œåƒæºï¼ˆä¼˜å…ˆä½¿ç”¨é˜¿é‡Œäº‘ï¼Œæ›´ç¨³å®šï¼‰
RUN sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources 2>/dev/null || \
    sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list || \
    echo "deb http://mirrors.aliyun.com/debian bullseye main contrib non-free" > /etc/apt/sources.list && \
    echo "deb http://mirrors.aliyun.com/debian bullseye-updates main contrib non-free" >> /etc/apt/sources.list && \
    echo "deb http://mirrors.aliyun.com/debian-security bullseye-security main contrib non-free" >> /etc/apt/sources.list

WORKDIR /app

ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1

# åˆ›å»ºç³»ç»Ÿç”¨æˆ·å’Œç»„ï¼ˆDebian ä½¿ç”¨ä¸åŒçš„å‘½ä»¤ï¼‰
RUN groupadd --system --gid 1001 nodejs && \
    useradd --system --uid 1001 --gid nodejs --shell /bin/bash --create-home nextjs

# é…ç½® npm ä½¿ç”¨æ·˜å®é•œåƒæºï¼ˆç”¨äº npx å‘½ä»¤ï¼‰
RUN npm config set registry https://registry.npmmirror.com

# å®‰è£…å¿…è¦çš„å·¥å…·ï¼ˆä½¿ç”¨ apt-getï¼Œæ›´ç¨³å®šï¼‰
# åŒ…å« FFmpeg ç”¨äº HLS éŸ³é¢‘è½¬ç 
# åŒ…å« git å’Œ bash ç”¨äºå®‰è£… clash
# åŒ…å« net-toolsï¼ˆæä¾› netstatï¼‰ç”¨äº clash å®‰è£…è„šæœ¬
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      wget \
      mariadb-client \
      curl \
      ca-certificates \
      ffmpeg \
      git \
      bash \
      net-tools \
      && rm -rf /var/lib/apt/lists/*

# å®‰è£… clashï¼ˆéœ€è¦ root æƒé™ï¼‰
# ä½¿ç”¨ gh-proxy ä»£ç†è®¿é—® GitHubï¼ˆå¦‚æœæœåŠ¡å™¨æ— æ³•ç›´æ¥è®¿é—®ï¼‰
# æ³¨æ„ï¼šå®‰è£…è„šæœ¬åœ¨æœ€åä¼šå°è¯•äº¤äº’å¼æ·»åŠ è®¢é˜…ï¼Œæˆ‘ä»¬å…è®¸è¿™éƒ¨åˆ†å¤±è´¥
# è®¢é˜…é…ç½®å°†åœ¨å®¹å™¨å¯åŠ¨æ—¶é€šè¿‡ docker-entrypoint.mjs å®Œæˆ
RUN cd /tmp && \
    (git clone --branch master --depth 1 https://gh-proxy.org/https://github.com/nelvko/clash-for-linux-install.git 2>/dev/null || \
     git clone --branch master --depth 1 https://github.com/nelvko/clash-for-linux-install.git 2>/dev/null || \
     (echo "âš ï¸  Clash å®‰è£…å¤±è´¥ï¼Œå°†åœ¨è¿è¡Œæ—¶å¤„ç†" && exit 1)) && \
    if [ -d "clash-for-linux-install" ]; then \
        cd clash-for-linux-install && \
        # è¿è¡Œå®‰è£…è„šæœ¬ï¼Œå…è®¸äº¤äº’å¼éƒ¨åˆ†å¤±è´¥ï¼ˆé€€å‡ºç é0ï¼‰
        # ä½¿ç”¨ echo "" | æä¾›ç©ºè¾“å…¥ï¼ˆå…¼å®¹ /bin/shï¼Œä¸ä¾èµ– bash çš„ here-stringï¼‰
        # ä»é”™è¯¯æ—¥å¿—çœ‹ï¼Œclash æ ¸å¿ƒå·²ç»å®‰è£…æˆåŠŸï¼Œåªæ˜¯æœ€åçš„è®¢é˜…é…ç½®å¤±è´¥
        # ä½¿ç”¨ set +e ç¡®ä¿å³ä½¿è„šæœ¬å¤±è´¥ä¹Ÿç»§ç»­æ‰§è¡Œ
        set +e; \
        echo "" | bash install.sh 2>&1; \
        INSTALL_EXIT_CODE=$?; \
        set -e; \
        # éªŒè¯ clash æ ¸å¿ƒæ˜¯å¦å®‰è£…æˆåŠŸï¼ˆè¿™æ˜¯å…³é”®æ£€æŸ¥ï¼‰
        # æ£€æŸ¥æ‰€æœ‰ clash ç›¸å…³å‘½ä»¤æ˜¯å¦å¯ç”¨ï¼ˆç”¨æˆ·ç¡®è®¤åªè¦è¿™äº›å‘½ä»¤å¯ç”¨å³å¯ï¼‰
        # é¦–å…ˆæ£€æŸ¥ /root/clashctl ç›®å½•æ˜¯å¦å­˜åœ¨ï¼ˆè¿™æ˜¯å®‰è£…è„šæœ¬çš„æ ‡å‡†ä½ç½®ï¼‰
        if [ -d "/root/clashctl" ]; then \
            echo "âœ… æ£€æµ‹åˆ° /root/clashctl ç›®å½•ï¼ŒClash æ ¸å¿ƒå·²å®‰è£…"; \
            CLASH_AVAILABLE=true; \
        else \
            # æ£€æŸ¥å‘½ä»¤æ˜¯å¦åœ¨ PATH ä¸­
            CLASH_COMMANDS="clashctl clashlog clashoff clashproxy clashsecret clashsub clashui clashhelp clashmixin clashon clashrestart clashstatus clashtun clashupgrade"; \
            CLASH_AVAILABLE=false; \
            for cmd in $CLASH_COMMANDS; do \
                if command -v "$cmd" >/dev/null 2>&1 || \
                   [ -f "/usr/local/bin/$cmd" ]; then \
                    CLASH_AVAILABLE=true; \
                    break; \
                fi; \
            done; \
        fi; \
        # å¦‚æœå‘½ä»¤å¯ç”¨ï¼Œç¡®ä¿å®ƒä»¬åœ¨ PATH ä¸­
        if [ "$CLASH_AVAILABLE" = "true" ]; then \
            echo "âœ… Clash æ ¸å¿ƒå®‰è£…æˆåŠŸï¼ˆclash å‘½ä»¤å¯ç”¨ï¼Œäº¤äº’å¼è®¢é˜…é…ç½®å°†åœ¨å®¹å™¨å¯åŠ¨æ—¶å®Œæˆï¼‰"; \
            # ç¡®ä¿ clashctl ç›¸å…³å‘½ä»¤åœ¨ PATH ä¸­ï¼ˆå¦‚æœä¸åœ¨ï¼‰
            if [ -d "/root/clashctl" ]; then \
                # é“¾æ¥æ‰€æœ‰å¯æ‰§è¡Œæ–‡ä»¶åˆ° /usr/local/bin
                for cmd_file in /root/clashctl/*; do \
                    if [ -f "$cmd_file" ] && [ ! -d "$cmd_file" ]; then \
                        cmd_name=$(basename "$cmd_file"); \
                        # å¦‚æœæ˜¯è„šæœ¬æ–‡ä»¶ï¼Œç¡®ä¿å¯æ‰§è¡Œ
                        chmod +x "$cmd_file" 2>/dev/null || true; \
                        # åˆ›å»ºç¬¦å·é“¾æ¥
                        if ! command -v "$cmd_name" >/dev/null 2>&1; then \
                            ln -sf "$cmd_file" "/usr/local/bin/$cmd_name" 2>/dev/null || true; \
                        fi; \
                    fi; \
                done; \
                # åŒæ—¶æ£€æŸ¥ scripts/cmd ç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if [ -d "/root/clashctl/scripts/cmd" ]; then \
                    # ç¡®ä¿è„šæœ¬æ–‡ä»¶æœ‰å¯è¯»æƒé™ï¼ˆè®© nextjs ç”¨æˆ·å¯ä»¥é€šè¿‡ sudo è¯»å–ï¼‰
                    chmod -R a+r /root/clashctl/scripts/cmd/*.sh 2>/dev/null || true; \
                    chmod +x /root/clashctl/scripts/cmd/*.sh 2>/dev/null || true; \
                    for cmd_file in /root/clashctl/scripts/cmd/*.sh; do \
                        if [ -f "$cmd_file" ]; then \
                            cmd_name=$(basename "$cmd_file" .sh); \
                            if ! command -v "$cmd_name" >/dev/null 2>&1; then \
                                # åˆ›å»ºä¸€ä¸ªåŒ…è£…è„šæœ¬ï¼Œsource åŸå§‹è„šæœ¬ç„¶åæ‰§è¡Œå‡½æ•°
                                echo "#!/bin/bash" > "/usr/local/bin/$cmd_name" && \
                                echo "source $cmd_file" >> "/usr/local/bin/$cmd_name" && \
                                echo "\$$cmd_name \"\$@\"" >> "/usr/local/bin/$cmd_name" && \
                                chmod +x "/usr/local/bin/$cmd_name" 2>/dev/null || true; \
                            fi; \
                        fi; \
                    done; \
                fi; \
            fi; \
        else \
            echo "âŒ Clash æ ¸å¿ƒå®‰è£…å¤±è´¥ï¼ˆclash å‘½ä»¤ä¸å¯ç”¨ï¼‰"; \
            echo "è°ƒè¯•ä¿¡æ¯ï¼šæŸ¥æ‰¾ clash ç›¸å…³æ–‡ä»¶..."; \
            find /root -name "clash*" 2>/dev/null | head -10 || true; \
            find /usr/local -name "clash*" 2>/dev/null | head -10 || true; \
            exit 1; \
        fi; \
        cd / && \
        rm -rf /tmp/clash-for-linux-install; \
    else \
        echo "âš ï¸  Clash å®‰è£…è„šæœ¬ä¸‹è½½å¤±è´¥ï¼Œè¯·ç¡®ä¿æœåŠ¡å™¨å¯ä»¥è®¿é—® GitHub æˆ–é…ç½®ä»£ç†"; \
        exit 1; \
    fi

# å¤åˆ¶ standalone è¾“å‡ºçš„æ‰€æœ‰æ–‡ä»¶
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static
COPY --from=builder --chown=nextjs:nodejs /app/public ./public

# å¤åˆ¶ Prisma ç›¸å…³æ–‡ä»¶ï¼ˆstandalone æ¨¡å¼ä¸è‡ªåŠ¨åŒ…å«ï¼‰
COPY --from=builder --chown=nextjs:nodejs /app/prisma ./prisma

# å¤åˆ¶æ•´ä¸ª node_modulesï¼ˆç¡®ä¿æ‰€æœ‰ä¾èµ–éƒ½å¯ç”¨ï¼ŒåŒ…æ‹¬åˆå§‹åŒ–è„šæœ¬éœ€è¦çš„ mysql2ã€bcryptjs ç­‰ï¼‰
COPY --from=builder --chown=nextjs:nodejs /app/node_modules ./node_modules

# å¤åˆ¶åˆå§‹åŒ–è„šæœ¬
COPY --from=builder --chown=nextjs:nodejs /app/scripts ./scripts

# åˆ›å»ºå¯åŠ¨è„šæœ¬ï¼ˆé…ç½® clashã€å¯åŠ¨ clashã€è¿è¡Œæ•°æ®åº“è¿ç§»ã€å¯åŠ¨åº”ç”¨ï¼‰
# æ³¨æ„ï¼šclash éœ€è¦ root æƒé™ï¼Œæ‰€ä»¥ä½¿ç”¨ sudo å¯åŠ¨ clash
RUN echo '#!/bin/bash' > /app/docker-entrypoint.sh && \
    echo 'set -e' >> /app/docker-entrypoint.sh && \
    echo 'export PATH="/app/node_modules/.bin:$PATH"' >> /app/docker-entrypoint.sh && \
    echo '' >> /app/docker-entrypoint.sh && \
    echo '# è¿è¡Œåˆå§‹åŒ–è„šæœ¬ï¼ˆé…ç½® clash å’Œæ•°æ®åº“è¿ç§»ï¼‰' >> /app/docker-entrypoint.sh && \
    echo 'if [ -f "./scripts/docker-entrypoint.mjs" ]; then' >> /app/docker-entrypoint.sh && \
    echo '  node ./scripts/docker-entrypoint.mjs' >> /app/docker-entrypoint.sh && \
    echo 'else' >> /app/docker-entrypoint.sh && \
    echo '  echo "âš ï¸  docker-entrypoint.mjs ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–"' >> /app/docker-entrypoint.sh && \
    echo 'fi' >> /app/docker-entrypoint.sh && \
    echo '' >> /app/docker-entrypoint.sh && \
    echo '# å¯åŠ¨ clash ä»£ç†ï¼ˆå¦‚æœå¯ç”¨ï¼Œåœ¨é…ç½®å®Œæˆåå¯åŠ¨ï¼‰' >> /app/docker-entrypoint.sh && \
    echo 'if [ "${ENABLE_PROXY:-false}" = "true" ]; then' >> /app/docker-entrypoint.sh && \
    echo '  echo "ğŸŒ å¯åŠ¨ clash ä»£ç†..."' >> /app/docker-entrypoint.sh && \
    echo '  # clashon æ˜¯ bash å‡½æ•°ï¼Œä¸æ˜¯å¯æ‰§è¡Œæ–‡ä»¶ï¼Œéœ€è¦é€šè¿‡ source åŠ è½½' >> /app/docker-entrypoint.sh && \
    echo '  # å°è¯•å¤šç§æ–¹å¼åŠ è½½ clashon å‡½æ•°' >> /app/docker-entrypoint.sh && \
    echo '  if [ -f "/root/clashctl/scripts/cmd/clashctl.sh" ]; then' >> /app/docker-entrypoint.sh && \
    echo '    # ç›´æ¥ source clashctl.sh æ–‡ä»¶ï¼ˆæœ€å¯é çš„æ–¹å¼ï¼‰' >> /app/docker-entrypoint.sh && \
    echo '    sudo bash -c "source /root/clashctl/scripts/cmd/clashctl.sh && clashon" 2>/dev/null || true' >> /app/docker-entrypoint.sh && \
    echo '  else' >> /app/docker-entrypoint.sh && \
    echo '    # å°è¯•é€šè¿‡ .bashrc åŠ è½½ï¼ˆå¦‚æœå­˜åœ¨ï¼‰' >> /app/docker-entrypoint.sh && \
    echo '    sudo bash -c "source /root/.bashrc 2>/dev/null && clashon" 2>/dev/null || \' >> /app/docker-entrypoint.sh && \
    echo '    sudo -i bash -c "clashon" 2>/dev/null || \' >> /app/docker-entrypoint.sh && \
    echo '    (echo "âš ï¸  æ— æ³•ä½¿ç”¨ clashonï¼Œå°è¯•ä½¿ç”¨ clashctl..." && sudo clashctl on 2>/dev/null || true)' >> /app/docker-entrypoint.sh && \
    echo '  fi' >> /app/docker-entrypoint.sh && \
    echo '  sleep 3' >> /app/docker-entrypoint.sh && \
    echo '  echo "âœ… Clash ä»£ç†å·²å¯åŠ¨"' >> /app/docker-entrypoint.sh && \
    echo 'fi' >> /app/docker-entrypoint.sh && \
    echo '' >> /app/docker-entrypoint.sh && \
    echo '# è®¾ç½®ä»£ç†ç¯å¢ƒå˜é‡ï¼ˆå¦‚æœå¯ç”¨ï¼‰' >> /app/docker-entrypoint.sh && \
    echo 'if [ "${ENABLE_PROXY:-false}" = "true" ]; then' >> /app/docker-entrypoint.sh && \
    echo '  export HTTP_PROXY="${PROXY_HTTP:-http://127.0.0.1:7890}"' >> /app/docker-entrypoint.sh && \
    echo '  export HTTPS_PROXY="${PROXY_HTTPS:-http://127.0.0.1:7890}"' >> /app/docker-entrypoint.sh && \
    echo '  export ALL_PROXY="${PROXY_ALL:-socks5://127.0.0.1:7890}"' >> /app/docker-entrypoint.sh && \
    echo '  export NO_PROXY="${PROXY_NO_PROXY:-localhost,127.0.0.1,::1}"' >> /app/docker-entrypoint.sh && \
    echo '  # è®¾ç½® Node.js ä½¿ç”¨çš„ä»£ç†ç¯å¢ƒå˜é‡ï¼ˆNode.js 18+ fetch éœ€è¦è¿™äº›å˜é‡ï¼‰' >> /app/docker-entrypoint.sh && \
    echo '  export NODE_EXTRA_CA_CERTS=""' >> /app/docker-entrypoint.sh && \
    echo '  echo "ğŸ”§ ä»£ç†ç¯å¢ƒå˜é‡å·²è®¾ç½®: HTTP_PROXY=$HTTP_PROXY"' >> /app/docker-entrypoint.sh && \
    echo '  echo "ğŸ”§ Node.js å°†ä½¿ç”¨ä»£ç†: HTTPS_PROXY=$HTTPS_PROXY"' >> /app/docker-entrypoint.sh && \
    echo 'fi' >> /app/docker-entrypoint.sh && \
    echo '' >> /app/docker-entrypoint.sh && \
    echo 'echo "ğŸš€ å¯åŠ¨åº”ç”¨..."' >> /app/docker-entrypoint.sh && \
    echo 'exec node server.js' >> /app/docker-entrypoint.sh && \
    chmod +x /app/docker-entrypoint.sh && \
    chown nextjs:nodejs /app/docker-entrypoint.sh

# é…ç½® sudoï¼Œå…è®¸ nextjs ç”¨æˆ·ä»¥ root æƒé™è¿è¡Œ clash ç›¸å…³å‘½ä»¤
# å®‰è£… sudoï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
RUN apt-get update && \
    apt-get install -y --no-install-recommends sudo && \
    # å…è®¸ nextjs ç”¨æˆ·æ— å¯†ç æ‰§è¡Œ bash å‘½ä»¤ï¼ˆç”¨äº source clashctl.sh å’Œæ‰§è¡Œ clash å‘½ä»¤ï¼‰
    echo "nextjs ALL=(ALL) NOPASSWD: /bin/bash" >> /etc/sudoers && \
    rm -rf /var/lib/apt/lists/*

USER nextjs

EXPOSE 3000

ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# ä½¿ç”¨å¯åŠ¨è„šæœ¬ï¼Œè‡ªåŠ¨è¿è¡Œæ•°æ®åº“è¿ç§»
ENTRYPOINT ["/app/docker-entrypoint.sh"]

